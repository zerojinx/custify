<script>
document.addEventListener('DOMContentLoaded', async function () {
  const container = document.getElementById('custify-rewards-block');
  
  const settings = {
    heading: {{ section.settings.heading | default: 'Your Rewards' | json }},
    showPoints: {{ section.settings.show_points | default: true | json }},
    showCoupon: {{ section.settings.show_coupon | default: true | json }}
  };

  if (!container) {
    return;
  }

  try {
    let requestUrl = '/apps/custify';

    {% if customer %}
      const customerId = {{ customer.id | json }};
      const shop = {{ shop.permanent_domain | json }};
      const timestamp = Math.floor(Date.now() / 1000);
      const params = new URLSearchParams({
        shop,
        customerId,
        timestamp
      });
      requestUrl += '?' + params.toString();
    {% endif %}

    const response = await fetch(requestUrl, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
    }

    const data = await response.json();

    let contentHtml = `<h3>${settings.heading || 'Your Rewards'}</h3>`;

    if (data.error) {
      contentHtml += `<div class="custify-error">Error: ${data.error}</div>`;
    } else if (data.message && !data.hasData) {
      contentHtml += `<div class="custify-message">${data.message}</div>`;
    } else if (!data.hasData) {
      contentHtml += `<div class="custify-empty">No rewards available yet.</div>`;
    } else {
      
      // Shows point
      if (data.points !== undefined && data.points !== null) {
        contentHtml += `
          <div class="custify-reward-item">
            <span class="custify-reward-label">Points:</span>
            <span class="custify-reward-value">${data.points}</span>
          </div>
        `;
      }

      // Show coupon
      if (data.couponCode) {
        contentHtml += `
          <div class="custify-reward-item">
            <span class="custify-reward-label">Coupon Code:</span>
            <span class="custify-coupon-code">${data.couponCode}</span>
          </div>
        `;
      }
    }

    container.innerHTML = contentHtml;
    
  } catch (error) {
    container.innerHTML = `
      <div class="custify-error">
        Unable to load rewards.
      </div>
    `;
  }
});
</script>

<style>
#custify-rewards-block {
  font-family: inherit;
  font-size: 16px;
  color: #333;
}

.custify-reward-item {
  margin-bottom: 8px;
}

.custify-reward-label {
  font-weight: bold;
  margin-right: 4px;
}

.custify-coupon-code {
  background-color: #f4f4f4;
  padding: 4px 8px;
  border-radius: 4px;
  font-family: monospace;
}

.custify-error {
  color: red;
}

.custify-empty,
.custify-message {
  color: #666;
  font-style: italic;
}
</style>